---
- name: Create health check script
  copy:
    dest: /usr/local/bin/health-check.sh
    mode: '0755'
    content: |
      #!/bin/bash

      VPS_IP="{{ vps_ip }}"
      VPS_PORT="{{ xui_health_check_port }}"
      CHECK_INTERVAL="{{ health_check_interval }}"
      CHECK_TIMEOUT="{{ health_check_timeout }}"
      FAIL_THRESHOLD="{{ health_check_failures_threshold }}"
      LOG_FILE="{{ health_check_log }}"

      VPS_FAILURES=0
      DNS_FAILURES=0
      WG_FAILURES=0
      KILL_SWITCH_ACTIVE=false

      log_message() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
      }

      check_wireguard() {
        if wg show wg0 > /dev/null 2>&1; then
          HANDSHAKE=$(wg show wg0 latest-handshakes | awk '{print $2}')
          if [ -n "$HANDSHAKE" ] && [ "$HANDSHAKE" != "0" ]; then
            NOW=$(date +%s)
            AGE=$((NOW - HANDSHAKE))
            if [ $AGE -lt 180 ]; then
              return 0
            fi
          fi
        fi
        return 1
      }

      check_vps_health() {
        if timeout "$CHECK_TIMEOUT" curl -s -f "http://${VPS_IP}:${VPS_PORT}/health" > /dev/null 2>&1; then
          return 0
        else
          return 1
        fi
      }

      check_dns_health() {
        if systemctl is-active --quiet pihole-FTL && \
           timeout "$CHECK_TIMEOUT" dig @127.0.0.1 google.com > /dev/null 2>&1; then
          return 0
        else
          return 1
        fi
      }

      activate_kill_switch() {
        if [ "$KILL_SWITCH_ACTIVE" = false ]; then
          log_message "CRITICAL: Activating kill switch - blocking all traffic"

          nft add chain inet filter kill_switch '{ type filter hook forward priority -1; policy drop; }'

          KILL_SWITCH_ACTIVE=true
          log_message "Kill switch activated"
        fi
      }

      deactivate_kill_switch() {
        if [ "$KILL_SWITCH_ACTIVE" = true ]; then
          log_message "Services restored - deactivating kill switch"

          nft delete chain inet filter kill_switch 2>/dev/null || true

          KILL_SWITCH_ACTIVE=false
          log_message "Kill switch deactivated - traffic restored"
        fi
      }

      log_message "Health check service started"

      while true; do
        WG_HEALTHY=false
        VPS_HEALTHY=false
        DNS_HEALTHY=false

        if check_wireguard; then
          WG_HEALTHY=true
          WG_FAILURES=0
        else
          WG_FAILURES=$((WG_FAILURES + 1))
          log_message "WARNING: WireGuard check failed (${WG_FAILURES}/${FAIL_THRESHOLD})"
        fi

        if check_vps_health; then
          VPS_HEALTHY=true
          VPS_FAILURES=0
        else
          VPS_FAILURES=$((VPS_FAILURES + 1))
          log_message "WARNING: VPS health check failed (${VPS_FAILURES}/${FAIL_THRESHOLD})"
        fi

        if check_dns_health; then
          DNS_HEALTHY=true
          DNS_FAILURES=0
        else
          DNS_FAILURES=$((DNS_FAILURES + 1))
          log_message "WARNING: DNS health check failed (${DNS_FAILURES}/${FAIL_THRESHOLD})"
        fi

        if [ $WG_FAILURES -ge $FAIL_THRESHOLD ] || [ $VPS_FAILURES -ge $FAIL_THRESHOLD ] || [ $DNS_FAILURES -ge $FAIL_THRESHOLD ]; then
          if [ $WG_FAILURES -ge $FAIL_THRESHOLD ]; then
            log_message "CRITICAL: WireGuard tunnel down - threshold exceeded"
          fi
          if [ $VPS_FAILURES -ge $FAIL_THRESHOLD ]; then
            log_message "CRITICAL: VPS proxy unreachable - threshold exceeded"
          fi
          if [ $DNS_FAILURES -ge $FAIL_THRESHOLD ]; then
            log_message "CRITICAL: Pi-hole DNS failed - threshold exceeded"
          fi
          activate_kill_switch
        else
          if [ "$WG_HEALTHY" = true ] && [ "$VPS_HEALTHY" = true ] && [ "$DNS_HEALTHY" = true ]; then
            deactivate_kill_switch
          fi
        fi

        sleep "$CHECK_INTERVAL"
      done

- name: Create health check systemd service
  copy:
    dest: /etc/systemd/system/health-check.service
    mode: '0644'
    content: |
      [Unit]
      Description=Health Check and Kill Switch Service
      After=network.target pihole-FTL.service nftables.service wg-quick@wg0.service
      Requires=nftables.service

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/health-check.sh
      Restart=always
      RestartSec=10
      StandardOutput=append:{{ health_check_log }}
      StandardError=append:{{ health_check_log }}

      [Install]
      WantedBy=multi-user.target

- name: Create log directory
  file:
    path: /var/log/health-check
    state: directory
    mode: '0755'

- name: Create log file
  file:
    path: "{{ health_check_log }}"
    state: touch
    mode: '0644'

- name: Enable and start health check service
  systemd:
    name: health-check
    enabled: yes
    state: started
    daemon_reload: yes

- name: Create health check status script
  copy:
    dest: /usr/local/bin/health-status.sh
    mode: '0755'
    content: |
      #!/bin/bash
      echo "Triangle Architecture Health Status"
      echo "===================================="
      echo ""
      echo "WireGuard VPN:"
      if wg show wg0 > /dev/null 2>&1; then
        echo "  Status: Active"
        wg show wg0 | grep -E "endpoint|latest handshake|transfer" | sed 's/^/  /'
      else
        echo "  Status: INACTIVE"
      fi
      echo ""
      echo "VPS Proxy:"
      curl -s -f "http://{{ vps_ip }}:{{ xui_health_check_port }}/health" && echo " OK" || echo " FAILED"
      echo ""
      echo "Pi-hole DNS:"
      systemctl is-active pihole-FTL && echo " OK" || echo " FAILED"
      echo ""
      echo "Kill Switch:"
      nft list chain inet filter kill_switch > /dev/null 2>&1 && echo " ACTIVE (Traffic blocked)" || echo " Inactive (Traffic flowing)"
      echo ""
      echo "Services:"
      for svc in wlan0-setup hostapd pihole-FTL cloudflared wg-quick@wg0 nftables health-check; do
        status=$(systemctl is-active $svc 2>/dev/null || echo 'unknown')
        printf "  %-20s %s\n" "$svc:" "$status"
      done
      echo ""
      echo "Network:"
      echo "  eth0: $(ip -4 addr show eth0 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' || echo 'No IP')"
      echo "  wlan0: $(ip -4 addr show wlan0 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' || echo 'No IP')"
      echo "  wg0: $(ip -4 addr show wg0 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' || echo 'No IP')"
      echo ""
      echo "Recent logs:"
      tail -n 10 {{ health_check_log }}
