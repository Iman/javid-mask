---
- name: Check if sing-box is already installed
  stat:
    path: /usr/local/bin/sing-box
  register: singbox_binary

- name: Download sing-box
  get_url:
    url: "https://github.com/SagerNet/sing-box/releases/download/v{{ sing_box_version }}/sing-box-{{ sing_box_version }}-linux-arm64.tar.gz"
    dest: /tmp/sing-box.tar.gz
    mode: '0644'
  when: not singbox_binary.stat.exists

- name: Extract sing-box
  unarchive:
    src: /tmp/sing-box.tar.gz
    dest: /tmp/
    remote_src: yes
  when: not singbox_binary.stat.exists

- name: Install sing-box binary
  copy:
    src: "/tmp/sing-box-{{ sing_box_version }}-linux-arm64/sing-box"
    dest: /usr/local/bin/sing-box
    mode: '0755'
    remote_src: yes
  when: not singbox_binary.stat.exists

- name: Create sing-box directory
  file:
    path: /opt/singbox
    state: directory
    mode: '0755'

- name: Create sing-box configuration
  template:
    src: sing-box-config.json.j2
    dest: /opt/singbox/config.json
    mode: '0644'
  notify: restart singbox

- name: Create sing-box systemd service
  copy:
    dest: /etc/systemd/system/sing-box.service
    mode: '0644'
    content: |
      [Unit]
      Description=sing-box service
      Documentation=https://sing-box.sagernet.org
      After=network.target nss-lookup.target network-online.target

      [Service]
      CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_SYS_PTRACE CAP_DAC_READ_SEARCH
      AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_SYS_PTRACE CAP_DAC_READ_SEARCH
      ExecStart=/usr/local/bin/sing-box run -c /opt/singbox/config.json
      ExecReload=/bin/kill -HUP $MAINPID
      Restart=on-failure
      RestartSec=10s
      LimitNOFILE=infinity

      [Install]
      WantedBy=multi-user.target
  notify: restart singbox

- name: Enable and start sing-box
  systemd:
    name: sing-box
    enabled: yes
    state: started
    daemon_reload: yes
