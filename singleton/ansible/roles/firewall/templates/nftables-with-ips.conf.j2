#!/usr/sbin/nftables -f
# Raspberry Pi Firewall with Iranian IP Blocking
# Generated by Ansible

flush ruleset

table inet filter {
    # Iranian IP blocklist set
    set iranian_blocklist {
        type ipv4_addr
        flags interval
        auto-merge
        comment "Iranian IP ranges to block"
    }

    chain input {
        type filter hook input priority filter; policy accept;

        # Drop invalid packets first
        ct state invalid drop

        # Allow established/related connections
        ct state established,related accept

        # Allow loopback
        iif "lo" accept

        # BLOCK Iranian IPs (inbound to Pi)
        ip saddr @iranian_blocklist counter drop comment "Block Iranian IPs inbound"
        ip daddr @iranian_blocklist counter drop comment "Block Iranian IPs to Pi"
    }

    chain forward {
        type filter hook forward priority filter; policy drop;

        # Drop invalid packets
        ct state invalid drop

        # Allow established/related
        ct state established,related accept

        # CRITICAL: Block Iranian IPs for forwarded traffic (V2Ray/Proxy)
        # This prevents proxy clients from accessing Iranian IPs
        ip saddr @iranian_blocklist counter drop comment "Block Iranian IPs forward-in"
        ip daddr @iranian_blocklist counter drop comment "Block Iranian IPs forward-out"

        # Allow WiFi clients to Internet (after Iranian IP check passed)
        iifname "{{ wifi_interface }}" oifname "{{ ethernet_interface }}" accept

        # Allow return traffic from Internet to WiFi
        iifname "{{ ethernet_interface }}" oifname "{{ wifi_interface }}" ct state established,related accept
    }

    chain output {
        type filter hook output priority filter; policy accept;

        # BLOCK Iranian IPs (outbound from Pi itself)
        ip daddr @iranian_blocklist counter drop comment "Block Iranian IPs outbound"
    }
}

table ip nat {
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
        # Transparent proxy redirects can be added here if needed
    }

    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;

        # NAT masquerading for WiFi clients going to Internet via eth0
        oifname "{{ ethernet_interface }}" masquerade comment "NAT for WiFi clients"
    }
}
